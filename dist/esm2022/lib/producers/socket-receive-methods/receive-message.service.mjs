import { Injectable } from '@angular/core';
import * as i0 from "@angular/core";
export class ReceiveMessage {
    /**
     * Receives and processes a message, updating the messages array and handling
     * various message types and events.
     *
     * @param {ReceiveMessageOptions} options - The options for receiving the message.
     * @param {Object} options.message - The message object containing sender, receivers, content, timestamp, and group.
     * @param {Function} options.getUpdatedAllParams - Function to get updated parameters.
     * @param {Array} options.messages - Array of current messages.
     * @param {Array} options.participantsAll - Array of all participants.
     * @param {string} options.member - The current member.
     * @param {string} options.eventType - The type of event (e.g., "broadcast", "chat").
     * @param {string} options.islevel - The level of the current member.
     * @param {string} options.coHost - The co-host of the event.
     * @param {Function} options.updateMessages - Function to update the messages array.
     * @param {Function} options.updateShowMessagesBadge - Function to update the visibility of the messages badge.
     *
     * @returns {Promise<void>} A promise that resolves when the message has been processed.
     */
    receiveMessage = async ({ message, messages, participantsAll, member, eventType, islevel, coHost, updateMessages, updateShowMessagesBadge, }) => {
        // Add the received message to the messages array
        const { sender, receivers, message: content, timestamp, group } = message;
        let oldMessages = messages;
        messages = [...messages, { sender, receivers, message: content, timestamp, group }];
        // Filter out messages with banned senders in the participants array
        if (eventType !== 'broadcast' && eventType !== 'chat') {
            messages = messages.filter((message) => participantsAll.some((participant) => participant.name === message.sender && !participant.isBanned));
        }
        else {
            messages = messages.filter((message) => {
                const participant = participantsAll.find((participant) => participant.name === message.sender);
                return !participant || !participant.isBanned;
            });
        }
        updateMessages(messages);
        // Separate group and direct messages
        const oldGroupMessages = oldMessages.filter((message) => message.group);
        const oldDirectMessages = oldMessages.filter((message) => !message.group);
        // Render and update counts for group messages
        const groupMessages = messages.filter((message) => message.group);
        if (eventType !== 'broadcast' && eventType !== 'chat') {
            // Check if oldGroupMessages length is different from groupMessages length
            if (oldGroupMessages.length !== groupMessages.length) {
                // Identify new messages
                const newGroupMessages = groupMessages.filter((message) => !oldGroupMessages.some((oldMessage) => oldMessage.timestamp === message.timestamp));
                // Check if newGroupMessages sender is the member or receivers include the member
                const newGroupMessages2 = newGroupMessages.filter((message) => message.sender === member || message.receivers.includes(member));
                // Check if member is the sender of any newGroupMessages
                const newGroupMessages3 = newGroupMessages2.filter((message) => message.sender === member);
                // Check if member is the receiver of any newGroupMessages
                if (newGroupMessages.length > 0 && newGroupMessages.length !== newGroupMessages3.length) {
                    updateShowMessagesBadge(true);
                }
            }
        }
        // Render and update counts for direct messages
        const directMessages = messages.filter((message) => !message.group);
        if (eventType !== 'broadcast' && eventType !== 'chat') {
            // Check if oldDirectMessages length is different from directMessages length
            if (oldDirectMessages.length !== directMessages.length) {
                // Identify new direct messages
                const newDirectMessages = directMessages.filter((message) => !oldDirectMessages.some((oldMessage) => oldMessage.timestamp === message.timestamp));
                // Check if newDirectMessages sender is the member or receivers include the member
                const newDirectMessages2 = newDirectMessages.filter((message) => message.sender === member || message.receivers.includes(member));
                // Check if member is the sender of any newDirectMessages
                const newDirectMessages3 = newDirectMessages2.filter((message) => message.sender === member);
                if ((newDirectMessages.length > 0 && newDirectMessages2.length > 0) ||
                    (newDirectMessages.length > 0 && islevel === '2') ||
                    coHost === member) {
                    if (islevel === '2' || coHost === member) {
                        if (newDirectMessages.length !== newDirectMessages3.length) {
                            updateShowMessagesBadge(true);
                        }
                    }
                    else {
                        if (newDirectMessages2.length > 0 &&
                            newDirectMessages.length !== newDirectMessages3.length) {
                            updateShowMessagesBadge(true);
                        }
                    }
                }
            }
        }
    };
    static ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.8", ngImport: i0, type: ReceiveMessage, deps: [], target: i0.ɵɵFactoryTarget.Injectable });
    static ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.2.8", ngImport: i0, type: ReceiveMessage, providedIn: 'root' });
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.8", ngImport: i0, type: ReceiveMessage, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVjZWl2ZS1tZXNzYWdlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9tZWRpYXNmdS1hbmd1bGFyL3NyYy9saWIvcHJvZHVjZXJzL3NvY2tldC1yZWNlaXZlLW1ldGhvZHMvcmVjZWl2ZS1tZXNzYWdlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQzs7QUFxQjNDLE1BQU0sT0FBTyxjQUFjO0lBQ3pCOzs7Ozs7Ozs7Ozs7Ozs7OztPQWlCRztJQUVILGNBQWMsR0FBRyxLQUFLLEVBQUUsRUFDdEIsT0FBTyxFQUNQLFFBQVEsRUFDUixlQUFlLEVBQ2YsTUFBTSxFQUNOLFNBQVMsRUFDVCxPQUFPLEVBQ1AsTUFBTSxFQUNOLGNBQWMsRUFDZCx1QkFBdUIsR0FDRCxFQUFpQixFQUFFO1FBQ3pDLGlEQUFpRDtRQUNqRCxNQUFNLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsR0FBRyxPQUFPLENBQUM7UUFDMUUsSUFBSSxXQUFXLEdBQUcsUUFBUSxDQUFDO1FBQzNCLFFBQVEsR0FBRyxDQUFDLEdBQUcsUUFBUSxFQUFFLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBRXBGLG9FQUFvRTtRQUNwRSxJQUFJLFNBQVMsS0FBSyxXQUFXLElBQUksU0FBUyxLQUFLLE1BQU0sRUFBRSxDQUFDO1lBQ3RELFFBQVEsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBZ0IsRUFBRSxFQUFFLENBQzlDLGVBQWUsQ0FBQyxJQUFJLENBQ2xCLENBQUMsV0FBZ0IsRUFBRSxFQUFFLENBQUMsV0FBVyxDQUFDLElBQUksS0FBSyxPQUFPLENBQUMsTUFBTSxJ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QUMsQ0FBQzt1R0FwSVMsY0FBYzsyR0FBZCxjQUFjLGNBRmIsTUFBTTs7MkZBRVAsY0FBYztrQkFIMUIsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBFdmVudFR5cGUsIE1lc3NhZ2UsIFBhcnRpY2lwYW50IH0gZnJvbSAnLi4vLi4vQHR5cGVzL3R5cGVzJztcblxuZXhwb3J0IGludGVyZmFjZSBSZWNlaXZlTWVzc2FnZU9wdGlvbnMge1xuICBtZXNzYWdlOiBNZXNzYWdlO1xuICBtZXNzYWdlczogTWVzc2FnZVtdO1xuICBwYXJ0aWNpcGFudHNBbGw6IFBhcnRpY2lwYW50W107XG4gIG1lbWJlcjogc3RyaW5nO1xuICBldmVudFR5cGU6IEV2ZW50VHlwZTtcbiAgaXNsZXZlbDogc3RyaW5nO1xuICBjb0hvc3Q6IHN0cmluZztcbiAgdXBkYXRlTWVzc2FnZXM6IChtZXNzYWdlczogTWVzc2FnZVtdKSA9PiB2b2lkO1xuICB1cGRhdGVTaG93TWVzc2FnZXNCYWRnZTogKHNob3dCYWRnZTogYm9vbGVhbikgPT4gdm9pZDtcbn1cblxuLy8gRXhwb3J0IHRoZSB0eXBlIGRlZmluaXRpb24gZm9yIHRoZSBmdW5jdGlvblxuZXhwb3J0IHR5cGUgUmVjZWl2ZU1lc3NhZ2VUeXBlID0gKG9wdGlvbnM6IFJlY2VpdmVNZXNzYWdlT3B0aW9ucykgPT4gUHJvbWlzZTx2b2lkPjtcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCcsXG59KVxuZXhwb3J0IGNsYXNzIFJlY2VpdmVNZXNzYWdlIHtcbiAgLyoqXG4gICAqIFJlY2VpdmVzIGFuZCBwcm9jZXNzZXMgYSBtZXNzYWdlLCB1cGRhdGluZyB0aGUgbWVzc2FnZXMgYXJyYXkgYW5kIGhhbmRsaW5nXG4gICAqIHZhcmlvdXMgbWVzc2FnZSB0eXBlcyBhbmQgZXZlbnRzLlxuICAgKlxuICAgKiBAcGFyYW0ge1JlY2VpdmVNZXNzYWdlT3B0aW9uc30gb3B0aW9ucyAtIFRoZSBvcHRpb25zIGZvciByZWNlaXZpbmcgdGhlIG1lc3NhZ2UuXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zLm1lc3NhZ2UgLSBUaGUgbWVzc2FnZSBvYmplY3QgY29udGFpbmluZyBzZW5kZXIsIHJlY2VpdmVycywgY29udGVudCwgdGltZXN0YW1wLCBhbmQgZ3JvdXAuXG4gICAqIEBwYXJhbSB7RnVuY3Rpb259IG9wdGlvbnMuZ2V0VXBkYXRlZEFsbFBhcmFtcyAtIEZ1bmN0aW9uIHRvIGdldCB1cGRhdGVkIHBhcmFtZXRlcnMuXG4gICAqIEBwYXJhbSB7QXJyYXl9IG9wdGlvbnMubWVzc2FnZXMgLSBBcnJheSBvZiBjdXJyZW50IG1lc3NhZ2VzLlxuICAgKiBAcGFyYW0ge0FycmF5fSBvcHRpb25zLnBhcnRpY2lwYW50c0FsbCAtIEFycmF5IG9mIGFsbCBwYXJ0aWNpcGFudHMuXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBvcHRpb25zLm1lbWJlciAtIFRoZSBjdXJyZW50IG1lbWJlci5cbiAgICogQHBhcmFtIHtzdHJpbmd9IG9wdGlvbnMuZXZlbnRUeXBlIC0gVGhlIHR5cGUgb2YgZXZlbnQgKGUuZy4sIFwiYnJvYWRjYXN0XCIsIFwiY2hhdFwiKS5cbiAgICogQHBhcmFtIHtzdHJpbmd9IG9wdGlvbnMuaXNsZXZlbCAtIFRoZSBsZXZlbCBvZiB0aGUgY3VycmVudCBtZW1iZXIuXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBvcHRpb25zLmNvSG9zdCAtIFRoZSBjby1ob3N0IG9mIHRoZSBldmVudC5cbiAgICogQHBhcmFtIHtGdW5jdGlvbn0gb3B0aW9ucy51cGRhdGVNZXNzYWdlcyAtIEZ1bmN0aW9uIHRvIHVwZGF0ZSB0aGUgbWVzc2FnZXMgYXJyYXkuXG4gICAqIEBwYXJhbSB7RnVuY3Rpb259IG9wdGlvbnMudXBkYXRlU2hvd01lc3NhZ2VzQmFkZ2UgLSBGdW5jdGlvbiB0byB1cGRhdGUgdGhlIHZpc2liaWxpdHkgb2YgdGhlIG1lc3NhZ2VzIGJhZGdlLlxuICAgKlxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTx2b2lkPn0gQSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgd2hlbiB0aGUgbWVzc2FnZSBoYXMgYmVlbiBwcm9jZXNzZWQuXG4gICAqL1xuXG4gIHJlY2VpdmVNZXNzYWdlID0gYXN5bmMgKHtcbiAgICBtZXNzYWdlLFxuICAgIG1lc3NhZ2VzLFxuICAgIHBhcnRpY2lwYW50c0FsbCxcbiAgICBtZW1iZXIsXG4gICAgZXZlbnRUeXBlLFxuICAgIGlzbGV2ZWwsXG4gICAgY29Ib3N0LFxuICAgIHVwZGF0ZU1lc3NhZ2VzLFxuICAgIHVwZGF0ZVNob3dNZXNzYWdlc0JhZGdlLFxuICB9OiBSZWNlaXZlTWVzc2FnZU9wdGlvbnMpOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICAvLyBBZGQgdGhlIHJlY2VpdmVkIG1lc3NhZ2UgdG8gdGhlIG1lc3NhZ2VzIGFycmF5XG4gICAgY29uc3QgeyBzZW5kZXIsIHJlY2VpdmVycywgbWVzc2FnZTogY29udGVudCwgdGltZXN0YW1wLCBncm91cCB9ID0gbWVzc2FnZTtcbiAgICBsZXQgb2xkTWVzc2FnZXMgPSBtZXNzYWdlcztcbiAgICBtZXNzYWdlcyA9IFsuLi5tZXNzYWdlcywgeyBzZW5kZXIsIHJlY2VpdmVycywgbWVzc2FnZTogY29udGVudCwgdGltZXN0YW1wLCBncm91cCB9XTtcblxuICAgIC8vIEZpbHRlciBvdXQgbWVzc2FnZXMgd2l0aCBiYW5uZWQgc2VuZGVycyBpbiB0aGUgcGFydGljaXBhbnRzIGFycmF5XG4gICAgaWYgKGV2ZW50VHlwZSAhPT0gJ2Jyb2FkY2FzdCcgJiYgZXZlbnRUeXBlICE9PSAnY2hhdCcpIHtcbiAgICAgIG1lc3NhZ2VzID0gbWVzc2FnZXMuZmlsdGVyKChtZXNzYWdlOiBNZXNzYWdlKSA9PlxuICAgICAgICBwYXJ0aWNpcGFudHNBbGwuc29tZShcbiAgICAgICAgICAocGFydGljaXBhbnQ6IGFueSkgPT4gcGFydGljaXBhbnQubmFtZSA9PT0gbWVzc2FnZS5zZW5kZXIgJiYgIXBhcnRpY2lwYW50LmlzQmFubmVkLFxuICAgICAgICApLFxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbWVzc2FnZXMgPSBtZXNzYWdlcy5maWx0ZXIoKG1lc3NhZ2U6IE1lc3NhZ2UpID0+IHtcbiAgICAgICAgY29uc3QgcGFydGljaXBhbnQgPSBwYXJ0aWNpcGFudHNBbGwuZmluZChcbiAgICAgICAgICAocGFydGljaXBhbnQ6IGFueSkgPT4gcGFydGljaXBhbnQubmFtZSA9PT0gbWVzc2FnZS5zZW5kZXIsXG4gICAgICAgICk7XG4gICAgICAgIHJldHVybiAhcGFydGljaXBhbnQgfHwgIXBhcnRpY2lwYW50LmlzQmFubmVkO1xuICAgICAgfSk7XG4gICAgfVxuICAgIHVwZGF0ZU1lc3NhZ2VzKG1lc3NhZ2VzKTtcblxuICAgIC8vIFNlcGFyYXRlIGdyb3VwIGFuZCBkaXJlY3QgbWVzc2FnZXNcbiAgICBjb25zdCBvbGRHcm91cE1lc3NhZ2VzID0gb2xkTWVzc2FnZXMuZmlsdGVyKChtZXNzYWdlOiBNZXNzYWdlKSA9PiBtZXNzYWdlLmdyb3VwKTtcbiAgICBjb25zdCBvbGREaXJlY3RNZXNzYWdlcyA9IG9sZE1lc3NhZ2VzLmZpbHRlcigobWVzc2FnZTogTWVzc2FnZSkgPT4gIW1lc3NhZ2UuZ3JvdXApO1xuXG4gICAgLy8gUmVuZGVyIGFuZCB1cGRhdGUgY291bnRzIGZvciBncm91cCBtZXNzYWdlc1xuICAgIGNvbnN0IGdyb3VwTWVzc2FnZXMgPSBtZXNzYWdlcy5maWx0ZXIoKG1lc3NhZ2U6IE1lc3NhZ2UpID0+IG1lc3NhZ2UuZ3JvdXApO1xuXG4gICAgaWYgKGV2ZW50VHlwZSAhPT0gJ2Jyb2FkY2FzdCcgJiYgZXZlbnRUeXBlICE9PSAnY2hhdCcpIHtcbiAgICAgIC8vIENoZWNrIGlmIG9sZEdyb3VwTWVzc2FnZXMgbGVuZ3RoIGlzIGRpZmZlcmVudCBmcm9tIGdyb3VwTWVzc2FnZXMgbGVuZ3RoXG4gICAgICBpZiAob2xkR3JvdXBNZXNzYWdlcy5sZW5ndGggIT09IGdyb3VwTWVzc2FnZXMubGVuZ3RoKSB7XG4gICAgICAgIC8vIElkZW50aWZ5IG5ldyBtZXNzYWdlc1xuICAgICAgICBjb25zdCBuZXdHcm91cE1lc3NhZ2VzID0gZ3JvdXBNZXNzYWdlcy5maWx0ZXIoXG4gICAgICAgICAgKG1lc3NhZ2U6IE1lc3NhZ2UpID0+XG4gICAgICAgICAgICAhb2xkR3JvdXBNZXNzYWdlcy5zb21lKFxuICAgICAgICAgICAgICAob2xkTWVzc2FnZTogTWVzc2FnZSkgPT4gb2xkTWVzc2FnZS50aW1lc3RhbXAgPT09IG1lc3NhZ2UudGltZXN0YW1wLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgKTtcblxuICAgICAgICAvLyBDaGVjayBpZiBuZXdHcm91cE1lc3NhZ2VzIHNlbmRlciBpcyB0aGUgbWVtYmVyIG9yIHJlY2VpdmVycyBpbmNsdWRlIHRoZSBtZW1iZXJcbiAgICAgICAgY29uc3QgbmV3R3JvdXBNZXNzYWdlczIgPSBuZXdHcm91cE1lc3NhZ2VzLmZpbHRlcihcbiAgICAgICAgICAobWVzc2FnZTogTWVzc2FnZSkgPT4gbWVzc2FnZS5zZW5kZXIgPT09IG1lbWJlciB8fCBtZXNzYWdlLnJlY2VpdmVycy5pbmNsdWRlcyhtZW1iZXIpLFxuICAgICAgICApO1xuXG4gICAgICAgIC8vIENoZWNrIGlmIG1lbWJlciBpcyB0aGUgc2VuZGVyIG9mIGFueSBuZXdHcm91cE1lc3NhZ2VzXG4gICAgICAgIGNvbnN0IG5ld0dyb3VwTWVzc2FnZXMzID0gbmV3R3JvdXBNZXNzYWdlczIuZmlsdGVyKFxuICAgICAgICAgIChtZXNzYWdlOiBNZXNzYWdlKSA9PiBtZXNzYWdlLnNlbmRlciA9PT0gbWVtYmVyLFxuICAgICAgICApO1xuXG4gICAgICAgIC8vIENoZWNrIGlmIG1lbWJlciBpcyB0aGUgcmVjZWl2ZXIgb2YgYW55IG5ld0dyb3VwTWVzc2FnZXNcbiAgICAgICAgaWYgKG5ld0dyb3VwTWVzc2FnZXMubGVuZ3RoID4gMCAmJiBuZXdHcm91cE1lc3NhZ2VzLmxlbmd0aCAhPT0gbmV3R3JvdXBNZXNzYWdlczMubGVuZ3RoKSB7XG4gICAgICAgICAgdXBkYXRlU2hvd01lc3NhZ2VzQmFkZ2UodHJ1ZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBSZW5kZXIgYW5kIHVwZGF0ZSBjb3VudHMgZm9yIGRpcmVjdCBtZXNzYWdlc1xuICAgIGNvbnN0IGRpcmVjdE1lc3NhZ2VzID0gbWVzc2FnZXMuZmlsdGVyKChtZXNzYWdlOiBNZXNzYWdlKSA9PiAhbWVzc2FnZS5ncm91cCk7XG5cbiAgICBpZiAoZXZlbnRUeXBlICE9PSAnYnJvYWRjYXN0JyAmJiBldmVudFR5cGUgIT09ICdjaGF0Jykge1xuICAgICAgLy8gQ2hlY2sgaWYgb2xkRGlyZWN0TWVzc2FnZXMgbGVuZ3RoIGlzIGRpZmZlcmVudCBmcm9tIGRpcmVjdE1lc3NhZ2VzIGxlbmd0aFxuICAgICAgaWYgKG9sZERpcmVjdE1lc3NhZ2VzLmxlbmd0aCAhPT0gZGlyZWN0TWVzc2FnZXMubGVuZ3RoKSB7XG4gICAgICAgIC8vIElkZW50aWZ5IG5ldyBkaXJlY3QgbWVzc2FnZXNcbiAgICAgICAgY29uc3QgbmV3RGlyZWN0TWVzc2FnZXMgPSBkaXJlY3RNZXNzYWdlcy5maWx0ZXIoXG4gICAgICAgICAgKG1lc3NhZ2U6IE1lc3NhZ2UpID0+XG4gICAgICAgICAgICAhb2xkRGlyZWN0TWVzc2FnZXMuc29tZShcbiAgICAgICAgICAgICAgKG9sZE1lc3NhZ2U6IE1lc3NhZ2UpID0+IG9sZE1lc3NhZ2UudGltZXN0YW1wID09PSBtZXNzYWdlLnRpbWVzdGFtcCxcbiAgICAgICAgICAgICksXG4gICAgICAgICk7XG5cbiAgICAgICAgLy8gQ2hlY2sgaWYgbmV3RGlyZWN0TWVzc2FnZXMgc2VuZGVyIGlzIHRoZSBtZW1iZXIgb3IgcmVjZWl2ZXJzIGluY2x1ZGUgdGhlIG1lbWJlclxuICAgICAgICBjb25zdCBuZXdEaXJlY3RNZXNzYWdlczIgPSBuZXdEaXJlY3RNZXNzYWdlcy5maWx0ZXIoXG4gICAgICAgICAgKG1lc3NhZ2U6IE1lc3NhZ2UpID0+IG1lc3NhZ2Uuc2VuZGVyID09PSBtZW1iZXIgfHwgbWVzc2FnZS5yZWNlaXZlcnMuaW5jbHVkZXMobWVtYmVyKSxcbiAgICAgICAgKTtcblxuICAgICAgICAvLyBDaGVjayBpZiBtZW1iZXIgaXMgdGhlIHNlbmRlciBvZiBhbnkgbmV3RGlyZWN0TWVzc2FnZXNcbiAgICAgICAgY29uc3QgbmV3RGlyZWN0TWVzc2FnZXMzID0gbmV3RGlyZWN0TWVzc2FnZXMyLmZpbHRlcihcbiAgICAgICAgICAobWVzc2FnZTogTWVzc2FnZSkgPT4gbWVzc2FnZS5zZW5kZXIgPT09IG1lbWJlcixcbiAgICAgICAgKTtcblxuICAgICAgICBpZiAoXG4gICAgICAgICAgKG5ld0RpcmVjdE1lc3NhZ2VzLmxlbmd0aCA+IDAgJiYgbmV3RGlyZWN0TWVzc2FnZXMyLmxlbmd0aCA+IDApIHx8XG4gICAgICAgICAgKG5ld0RpcmVjdE1lc3NhZ2VzLmxlbmd0aCA+IDAgJiYgaXNsZXZlbCA9PT0gJzInKSB8fFxuICAgICAgICAgIGNvSG9zdCA9PT0gbWVtYmVyXG4gICAgICAgICkge1xuICAgICAgICAgIGlmIChpc2xldmVsID09PSAnMicgfHwgY29Ib3N0ID09PSBtZW1iZXIpIHtcbiAgICAgICAgICAgIGlmIChuZXdEaXJlY3RNZXNzYWdlcy5sZW5ndGggIT09IG5ld0RpcmVjdE1lc3NhZ2VzMy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgdXBkYXRlU2hvd01lc3NhZ2VzQmFkZ2UodHJ1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgbmV3RGlyZWN0TWVzc2FnZXMyLmxlbmd0aCA+IDAgJiZcbiAgICAgICAgICAgICAgbmV3RGlyZWN0TWVzc2FnZXMubGVuZ3RoICE9PSBuZXdEaXJlY3RNZXNzYWdlczMubGVuZ3RoXG4gICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgdXBkYXRlU2hvd01lc3NhZ2VzQmFkZ2UodHJ1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9O1xufVxuIl19